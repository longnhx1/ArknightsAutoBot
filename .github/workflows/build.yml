name: Build Arknights Bot

on:
  push:
    branches: [ "master", "dev" ] 
    tags:
      - 'v*' # QUAN TRỌNG: Chạy khi có tag bắt đầu bằng v (vd: v1.0, v1.0.1)
  workflow_dispatch:

permissions:
  contents: write # QUAN TRỌNG: Cấp quyền cho Bot được tạo Release

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    # --- CÁC BƯỚC BUILD CŨ (GIỮ NGUYÊN) ---
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' 

    - name: Build Python Logic
      working-directory: ./ArknightsBot.Logic
      run: |
        pip install pyinstaller
        pyinstaller --onefile --name ArknightsBot.Logic ArknightsBot.Logic.py

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: Build C# UI
      working-directory: ./ArknightsBot.UI
      run: dotnet publish -c Release -r win-x64 --self-contained false -o ./publish

    - name: Organize Files
      run: |
        mkdir Release
        mkdir Release/bin
        mkdir Release/adb
        mkdir Release/templates

        copy ArknightsBot.Logic/dist/ArknightsBot.Logic.exe Release/
        copy ArknightsBot.UI/publish/ArknightsBot.UI.exe Release/
        copy ArknightsBot.UI/publish/HandyControl.dll Release/
        copy ArknightsBot.UI/publish/ArknightsBot.UI.deps.json Release/
        copy ArknightsBot.UI/publish/ArknightsBot.UI.runtimeconfig.json Release/
        copy ArknightsBot.UI/publish/ArknightsBot.UI.dll Release/

        copy bin/* Release/bin/
        copy templates/* Release/templates/
        powershell Copy-Item -Path adb/* -Destination Release/adb -Recurse
        copy settings.json Release/

    # --- BƯỚC MỚI: NÉN FILE THỦ CÔNG ---
    # Nén folder Release thành file .zip để up lên trang Release
    - name: Zip Release
      run: powershell Compress-Archive -Path Release/* -DestinationPath ArknightsAutoBot.zip

    # --- BƯỚC MỚI: TẠO TRANG RELEASE ---
    # Chỉ chạy bước này nếu trigger là Tag (vd: v1.0)
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ArknightsAutoBot.zip # File sẽ đính kèm vào trang Release
        name: Release ${{ github.ref_name }} # Tên Release (vd: Release v1.0)
        body: "Bản cập nhật tự động từ GitHub Actions."
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}