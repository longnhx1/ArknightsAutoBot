name: Build Arknights Bot

on:
  push:
    branches: [ "master", "dev" ]
    tags:
      - 'v*' 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    # --- 1. SETUP & BUILD PYTHON ---
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10' 

    - name: Build Python Logic
      working-directory: ./ArknightsBot.Logic
      run: |
        pip install pyinstaller pywin32 numpy opencv-python
        pyinstaller --onefile --name ArknightsBot.Logic ArknightsBot.Logic.py

    # --- 2. SETUP & BUILD C# ---
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: Build C# UI
      working-directory: ./ArknightsBot.UI
      run: dotnet publish -c Release -r win-x64 --self-contained false -o ./publish

    # --- 3. GOM FILE VÀO FOLDER RELEASE ---
    - name: Organize Files
      run: |
        mkdir Release
        mkdir Release/bin
        mkdir Release/adb
        mkdir Release/templates

        copy ArknightsBot.Logic/dist/ArknightsBot.Logic.exe Release/
        copy ArknightsBot.UI/publish/ArknightsBot.UI.exe Release/
        copy ArknightsBot.UI/publish/HandyControl.dll Release/
        copy ArknightsBot.UI/publish/ArknightsBot.UI.deps.json Release/
        copy ArknightsBot.UI/publish/ArknightsBot.UI.runtimeconfig.json Release/
        copy ArknightsBot.UI/publish/ArknightsBot.UI.dll Release/

        copy bin/* Release/bin/
        copy templates/* Release/templates/
        powershell Copy-Item -Path adb/* -Destination Release/adb -Recurse
        copy settings.json Release/

    # --- 4. NÉN FILE ZIP (Để dùng cho cả 2 mục đích) ---
    - name: Zip Release
      run: powershell Compress-Archive -Path Release/* -DestinationPath ArknightsAutoBot.zip

    # --- 5. UPLOAD ARTIFACT (CHO NHÁNH DEV/TEST) ---
    # Bước này giúp bạn thấy file tải về ở mục Artifacts sau khi build xong
    - name: Upload Artifact for Dev
      uses: actions/upload-artifact@v4
      with:
        name: ArknightsAutoBot_Build
        path: ArknightsAutoBot.zip

    # --- 6. TẠO RELEASE (CHỈ KHI CÓ TAG v...) ---
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ArknightsAutoBot.zip
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}